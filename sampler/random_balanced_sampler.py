'''
    Create a random balanced sample by combining datasets split using
    splitter.py
'''

import csv
import random
import sys

if len(sys.argv) < 7:
    sys.exit(
        'Wrong number of arguments!\n'
        'Parameters: input_filepath0 input_filepath1 output_filepath '
        'input_size0 input_size1 sample_size\n'
        f'Example: python3 {sys.argv[0]} train0.csv train1.csv '
        'randombalancedsample10000_train.csv 4462591 4458892 10000'
    )

input_filepath0 = sys.argv[1]
input_filepath1 = sys.argv[2]
output_filepath = sys.argv[3]
input_size0 = int(sys.argv[4])
input_size1 = int(sys.argv[5])
sample_size = int(sys.argv[6])
class_size = sample_size // 2

selected_rows0 = sorted(random.sample(range(input_size0), class_size))
selected_rows1 = sorted(random.sample(range(input_size1), class_size))

input_file0 = open(input_filepath0)
input_file1 = open(input_filepath1)
output_file = open(output_filepath, 'w')

reader0 = csv.reader(input_file0)
reader1 = csv.reader(input_file1)
writer = csv.writer(output_file)

header = next(reader0)
writer.writerow(header)

next(reader1)   # Skip header

row_count = 0
selected_count0, selected_count1 = 0, 0
while True:
    if row_count < input_size0:
        row0 = next(reader0)
        if (selected_count0 < class_size
                and row_count == selected_rows0[selected_count0]):
            writer.writerow(row0)
            selected_count0 += 1
            print(f'Sampled {selected_count0} 0 rows')

    if row_count < input_size1:
        row1 = next(reader1)
        if (selected_count1 < class_size
                and row_count == selected_rows1[selected_count1]):
            writer.writerow(row1)
            selected_count1 += 1
            print(f'Sampled {selected_count0} 1 rows')

    row_count += 1
    print(f'Read {row_count} rows')
    if selected_count0 == class_size and selected_count1 == class_size:
        break

input_file0.close()
input_file1.close()
output_file.close()

print('Finished')
print(f'Sampled {selected_count0} rows')
print(f'Sampled {selected_count1} rows')
print('Sample 0 rows: ', selected_rows0)
print('Sample 1 rows: ', selected_rows1)
